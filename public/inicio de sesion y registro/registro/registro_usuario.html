<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Cuenta | Tienda Mas</title>
    <meta name="description" content="Create an account with Tienda Mas for faster checkout and personalized shopping">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #FF6B35;
            --primary-hover: #E55627;
            --secondary-color: #004E89;
            --light-gray: #F8F9FA;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--light-gray); color: #333; }
        .form-container { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        .input-icon { transition: all 0.2s ease; }
        .input-field:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.2); }
        .btn-primary { transition: all 0.2s ease; background-color: var(--primary-color); }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .password-toggle { right: 12px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #6B7280; }
        .password-toggle:hover { color: #374151; }
        .spinner { display: none; width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .section-title { font-weight: 600; color: #1f2937; margin-bottom: .5rem; }
        .section { border: 1px solid #e5e7eb; padding: 1rem; border-radius: .5rem; background: #fff; }
        .muted { color: #6b7280; font-size: .9rem; }

        /* Inicio Estado de Sesion */
        #session-status { position: fixed; top:12px; right:12px; width:260px; background:#fff; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.12); padding:10px 12px; font-size:13px; z-index:9999; color:#222; }
        #session-status .row { display:flex; justify-content:space-between; margin:6px 0; align-items:center; }
        #session-status .label { color:#666; }
        .status-dot { width:12px; height:12px; border-radius:50%; display:inline-block; margin-left:8px; vertical-align:middle; }
        .dot-green { background:#28a745; }
        .dot-red { background:#dc3545; }
        /* Fin Estado de Sesion */
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <main class="form-container bg-white rounded-xl p-8 w-full max-w-2xl space-y-6">
        <header class="text-center mb-2">
            <h1 class="text-3xl font-bold text-gray-800 mb-1 flex items-center justify-center">
                <span class="text-orange-500">Tienda</span>
                <span class="text-blue-600 ml-1">Mas</span>
            </h1>
            <p class="text-gray-600">Registrate y empezá a comprar fácil, rápido y seguro</p>
        </header>

        <form id="registrationForm" class="space-y-5" novalidate>
            <!-- USUARIO -->
            <section class="section space-y-4">
                <div class="section-title">Datos de usuario</div>
                <div class="grid grid-cols-1 gap-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-700">Usuario <span class="text-red-500">*</span></label>
                            <input type="text" id="username" name="username" required minlength="6" class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Elige un nombre de usuario" autocomplete="username">
                            <!-- Indicador disponibilidad usuario -->
                            <div id="usernameStatus" class="text-sm mt-1 h-5" aria-live="polite"></div>
                        </div>
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700">Correo electrónico <span class="text-red-500">*</span></label>
                            <input type="email" id="email" name="email" required class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="tu@email.com" autocomplete="email">
                            <!-- Indicador disponibilidad email -->
                            <div id="emailStatus" class="text-sm mt-1 h-5" aria-live="polite"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700">Contraseña <span class="text-red-500">*</span></label>
                            <!-- actualizar mínimo a 8 -->
                            <input type="password" id="password" name="password" required minlength="8" class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="••••••••" autocomplete="new-password">
                        </div>
                        <div>
                            <label for="passwordConfirm" class="block text-sm font-medium text-gray-700">Repetir contraseña <span class="text-red-500">*</span></label>
                            <!-- actualizar mínimo a 8 -->
                            <input type="password" id="passwordConfirm" name="passwordConfirm" required minlength="8" class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Repite la contraseña" autocomplete="new-password">
                        </div>
                    </div>
                    <section class="section space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <ul id="passwordChecklist" class="mt-2 space-y-1 text-sm" aria-live="polite">
                                    <li id="title" class="flex items-center"><i class="fa-solid"></i> La contraseña debe contener:</li>
                                    <li id="pwc-length" class="flex items-center text-red-600"><i class="fa-solid fa-circle-xmark mr-2"></i> Mínimo 8 caracteres</li>
                                    <li id="pwc-upper" class="flex items-center text-red-600"><i class="fa-solid fa-circle-xmark mr-2"></i> Al menos 1 mayúscula</li>
                                    <li id="pwc-number" class="flex items-center text-red-600"><i class="fa-solid fa-circle-xmark mr-2"></i> Al menos 1 número</li>
                                    <li id="pwc-special" class="flex items-center text-red-600"><i class="fa-solid fa-circle-xmark mr-2"></i> Al menos 1 caracter especial</li>
                                </ul>
                            </div>
                            <div>
                                <!-- Estado de coincidencia -->
                                <div id="passwordMatch" class="text-sm mt-1 h-5" aria-live="polite"></div>
                            </div>
                        </div>
                    </section>
                </div>
            </section>

            <!-- PERFIL USUARIO -->
            <section class="section space-y-4">
                <div class="section-title">Datos de Perfil</div>

                <div class="grid grid-cols-1 gap-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="firstName" class="block text-sm font-medium text-gray-700">Nombre <span class="text-red-500">*</span></label>
                            <input type="text" id="firstName" name="firstName" required class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Ingresa tu nombre" autocomplete="given-name">
                        </div>
                        <div>
                            <label for="lastName" class="block text-sm font-medium text-gray-700">Apellido <span class="text-red-500">*</span></label>
                            <input type="text" id="lastName" name="lastName" required class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Ingresa tu apellido" autocomplete="family-name">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="gender" class="block text-sm font-medium text-gray-700">Género <span class="text-red-500">*</span></label>
                            <select id="gender" name="gender" required class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg">
                                <option value="">Selecciona tu género</option>
                                <option value="MASCULINO">Masculino</option>
                                <option value="FEMENINO">Femenino</option>
                                <option value="OTRO">Otro</option>
                            </select>
                        </div>
                        <div>
                            <label for="document" class="block text-sm font-medium text-gray-700">Documento (DNI/CUIL) <span class="text-red-500">*</span></label>
                            <input type="text" id="document" name="document" required class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Ingresa tu documento">
                        </div>
                    </div>

                    <div>
                        <label for="birthDate" class="block text-sm font-medium text-gray-700">Fecha de nacimiento <span class="text-red-500">*</span></label>
                        <input type="date" id="birthDate" name="birthDate" required class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="YYYY-MM-DD">
                    </div>
                </div>
            </section>
            

            <!-- DIRECCION -->
            <section class="section space-y-4">
                <div class="section-title">Dirección</div>
                <p class="muted">Seleccioná ubicación en orden. Campos marcados con * son obligatorios.</p>

                <div class="grid grid-cols-1 gap-4">
                    <!-- Cascading selects para ubicación -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="provinciaSelect" class="block text-sm font-medium text-gray-700">Provincia <span class="text-red-500">*</span></label>
                            <select id="provinciaSelect" required class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg"></select>
                        </div>
                        <div>
                            <label for="departamentoSelect" class="block text-sm font-medium text-gray-700">Departamento (jurisdicción) <span class="text-red-500">*</span></label>
                            <select id="departamentoSelect" required class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg" disabled></select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="municipioSelect" class="block text-sm font-medium text-gray-700">Municipio <span class="text-red-500">*</span></label>
                            <select id="municipioSelect" required class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg" disabled></select>
                        </div>
                        <div>
                            <label for="localidadSelect" class="block text-sm font-medium text-gray-700">Localidad <span class="text-red-500">*</span></label>
                            <select id="localidadSelect" required class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg" disabled></select>
                        </div>
                    </div>

                    <!-- Calle, numero, piso, departamento interno, cp y referencia -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="street" class="block text-sm font-medium text-gray-700">Calle <span class="text-red-500">*</span></label>
                            <input type="text" id="street" name="street" required class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Ej: San Martín">
                        </div>
                        <div>
                            <label for="number" class="block text-sm font-medium text-gray-700">Número <span class="text-red-500">*</span></label>
                            <input type="text" id="number" name="number" required class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Ej: 1234">
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label for="floor" class="block text-sm font-medium text-gray-700">Piso</label>
                            <input type="text" id="floor" name="floor" class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Ej: 2">
                        </div>
                        <div>
                            <label for="apartment" class="block text-sm font-medium text-gray-700">Departamento (interno)</label>
                            <input type="text" id="apartment" name="apartment" class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Ej: A">
                        </div>
                        <div>
                            <label for="postalCode" class="block text-sm font-medium text-gray-700">Código Postal <span class="text-red-500">*</span></label>
                            <input type="text" id="postalCode" name="postalCode" required class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Ej: 1000">
                        </div>
                    </div>

                    <div>
                        <label for="reference" class="block text-sm font-medium text-gray-700">Referencia</label>
                        <textarea id="reference" name="reference" class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Ej: Frente a la plaza"></textarea>
                    </div>
                </div>
            </section>

            <!-- TELEFONO -->
            <section class="section space-y-4">
                <div class="section-title">Teléfono</div>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label for="phoneCode" class="block text-sm font-medium text-gray-700">Código <span class="text-red-500">*</span></label>
                        <input type="text" id="phoneCode" name="phoneCode" required class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="011">
                    </div>
                    <div class="col-span-2">
                        <label for="phoneNumber" class="block text-sm font-medium text-gray-700">Número <span class="text-red-500">*</span></label>
                        <input type="text" id="phoneNumber" name="phoneNumber" required class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="12345678">
                    </div>
                </div>
            </section>

            <!-- Cuadro de errores (rojo) -->
            <div id="errorBox" class="hidden border border-red-300 bg-red-50 text-red-800 rounded-lg p-4 text-sm" role="alert" aria-live="assertive">
                <div class="font-semibold mb-1">No se pudo completar el registro:</div>
                <ul id="errorList" class="list-disc pl-5 space-y-1"></ul>
            </div>

            <!-- TÉRMINOS Y BOTÓN -->
            <div class="flex items-start">
                <input id="terms" name="terms" type="checkbox" required class="w-4 h-4 border border-gray-300 rounded bg-gray-50 focus:ring-2 focus:ring-orange-500">
                <label for="terms" class="ml-3 text-sm text-gray-700">Acepto los <a href="#" class="text-orange-600 hover:underline">Términos y Condiciones</a> y la <a href="#" class="text-orange-600 hover:underline">Política de Privacidad</a><span class="text-red-500">*</span></label>
            </div>

            <button id="submitBtn" type="submit" class="btn-primary w-full text-white font-medium py-3 px-4 rounded-lg flex items-center justify-center">
                <span id="btnText">Crear cuenta</span>
                <div id="spinner" class="spinner ml-2"></div>
            </button>

            <div class="text-center text-sm text-gray-600">¿Ya tienes una cuenta? - <a href="iniciarSesion.html" class="font-medium text-orange-600 hover:underline">Iniciar sesión</a></div>
        </form>
    </main>

    <script>
        /*
        const BASE = '/api/import-ubicaciones';
        const ENDPOINT = {
            IMPORT_PROVINCIAS: `${BASE}/provincias`,
            IMPORT_DEPARTAMENTOS: `${BASE}/departamentos`,    // ?provincia=nombre
            IMPORT_LOCALIDADES: `${BASE}/localidades`,        // ?departamento=nombre
            IMPORT_MUNICIPIOS: `${BASE}/municipios`,          // ?localidad=nombre

            GET_PROVINCIAS: `${BASE}/provincias`,
            GET_DEPARTAMENTOS: `${BASE}/departamentos`,      // ?provinciaId=...
            GET_LOCALIDADES: `${BASE}/localidades`,          // ?departamentoId=...
            GET_MUNICIPIOS: `${BASE}/municipio-por-localidad` // ?localidadId=...
        };

        document.addEventListener('DOMContentLoaded', () => {
            initBirthDateConstraints();
            initLocationSelectors();
            // resto del form (submit) sigue igual si ya lo tenés implementado
            const form = document.getElementById('registrationForm');
            if (form) form.addEventListener('submit', (e) => {
                // valida cliente si querés antes de enviar...
                // e.preventDefault() si manejás envío manualmente
            });
        });*/

        // Nota: ubicaciones.js ya inicializa los selects (provincia/departamento/municipio/localidad).
        document.addEventListener('DOMContentLoaded', () => {
            initBirthDateConstraints();
            // Si tenés initLocationSelectors local, puede repetirse. El script /js/ubicaciones.js también hace init.
            try { if (typeof initLocationSelectors === 'function') initLocationSelectors(); } catch(e){/*ignore*/ }
            wireRealtimeValidation(); // NUEVO
            const form = document.getElementById('registrationForm');
            if (form) form.addEventListener('submit', handleSubmit);
        });

        // Constantes de API para comprobaciones en tiempo real (unificadas)
        const ACCOUNT_API = {
            CHECK_USERNAME: '/api/gestionusuario/public/usuario/disponible-username',
            CHECK_EMAIL: '/api/gestionusuario/public/usuario/disponible-email'
        };

        //function initBirthDateConstraints() {
        function initBirthDateConstraints() {
            const bd = document.getElementById('birthDate');
            if (!bd) return;
            const today = new Date();
            bd.max = today.toISOString().split('T')[0];
            bd.min = '1900-01-01';
        }

        function setOptions(select, items, placeholder) {
            select.innerHTML = '';
            const opt0 = document.createElement('option');
            opt0.value = '';
            opt0.textContent = placeholder || 'Seleccionar';
            select.appendChild(opt0);
            if (items && items.length) {
                items.forEach(it => {
                    const opt = document.createElement('option');
                    opt.value = it.id;               // guardamos id
                    opt.textContent = it.nombre;    // mostramos solo el nombre
                    select.appendChild(opt);
                });
                select.disabled = false;
            } else {
                select.disabled = true;
            }
        }

        function safeFetch(url, options) {
            return fetch(url, options).then(r => {
                if (!r.ok) return Promise.reject(r);
                // algunos POST devuelven texto, otros GET devuelven JSON
                const ct = r.headers.get('content-type') || '';
                return ct.includes('application/json') ? r.json() : r.text();
            });
        }

        function initLocationSelectors() {
            const prov = document.getElementById('provinciaSelect');
            const dept = document.getElementById('departamentoSelect');
            const loc  = document.getElementById('localidadSelect');
            const mun  = document.getElementById('municipioSelect');

            if (!prov || !dept || !loc || !mun) return;

            // Cargar provincias (GET)
            safeFetch(GET_PROVINCIAS)
                .then(data => setOptions(prov, data, 'Seleccionar provincia'))
                .catch(() => setOptions(prov, [], 'No disponible'));

            prov.addEventListener('change', () => {
                const provinciaId = prov.value;
                setOptions(dept, [], 'Cargando departamentos...');
                setOptions(mun, [], 'Seleccionar municipio');
                setOptions(loc, [], 'Seleccionar localidad');

                if (!provinciaId) return;

                // GET departamentos por provinciaId
                safeFetch(`${GET_DEPARTAMENTOS}?provinciaId=${encodeURIComponent(provinciaId)}`)
                    .then(data => setOptions(dept, data, 'Seleccionar departamento'))
                    .catch(() => setOptions(dept, [], 'No disponible'));
            });

            dept.addEventListener('change', () => {
                const departamentoId = dept.value;
                setOptions(mun, [], 'Cargando municipios...');
                setOptions(loc, [], 'Seleccionar localidad');

                if (!departamentoId) return;

                // GET municipios por departamentoId
                safeFetch(`${GET_MUNICIPIOS}?departamentoId=${encodeURIComponent(departamentoId)}`)
                    .then(data => setOptions(mun, data, 'Seleccionar municipio'))
                    .catch(() => setOptions(mun, [], 'No disponible'));
            });

            mun.addEventListener('change', () => {
                const municipioId = mun.value;
                setOptions(loc, [], 'Cargando localidades...');

                if (!municipioId) return;

                // GET localidades por municipioId
                safeFetch(`${GET_LOCALIDADES}?municipioId=${encodeURIComponent(municipioId)}`)
                    .then(data => setOptions(loc, data, 'Seleccionar localidad'))
                    .catch(() => setOptions(loc, [], 'No disponible'));
            });
        }
    
        // Helpers para manejo de errores
        function clearErrors() {
            const box = document.getElementById('errorBox');
            const list = document.getElementById('errorList');
            if (list) list.innerHTML = '';
            if (box) box.classList.add('hidden');
        }

        function showErrors(errors) {
            const box = document.getElementById('errorBox');
            const list = document.getElementById('errorList');
            if (!box || !list) return;
            list.innerHTML = '';
            errors.forEach(msg => {
                const li = document.createElement('li');
                li.textContent = msg;
                list.appendChild(li);
            });
            box.classList.remove('hidden');
            box.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Reemplazo: validateForm completo (sin parche)
        function validateForm() {
            const errors = [];
            const getEl = id => document.getElementById(id);
            const val = id => (getEl(id)?.value || '').trim();
            const onlyDigits = v => /^\d+$/.test(v);

            // Usuario
            const username = val('username');
            if (!username) errors.push('El campo Usuario no puede estar vacío.');
            else if (username.length < 6 || username.length > 16) errors.push('El Usuario debe tener entre 6 y 16 caracteres.');

            const emailEl = getEl('email');
            const email = val('email');
            if (!email) errors.push('El campo Correo electrónico es obligatorio.');
            else if (emailEl && emailEl.validity && emailEl.validity.typeMismatch) errors.push('El Correo electrónico no es válido.');

            // Contraseña fuerte + coincidencia
            const pass = val('password');
            const pass2 = val('passwordConfirm');
            if (!pass) errors.push('El campo Contraseña es obligatorio.');
            if (!pass2) errors.push('El campo Repetir contraseña es obligatorio.');
            if (pass && pass.length < 8) errors.push('La Contraseña debe tener al menos 8 caracteres.');
            if (pass && !/[A-Z]/.test(pass)) errors.push('La Contraseña debe incluir al menos una letra mayúscula.');
            if (pass && !/[0-9]/.test(pass)) errors.push('La Contraseña debe incluir al menos un número.');
            if (pass && !/[^A-Za-z0-9]/.test(pass)) errors.push('La Contraseña debe incluir al menos un caracter especial.');
            if (pass && pass2 && pass !== pass2) errors.push('El campo Contraseña y Repetir contraseña no coinciden.');

            // Perfil
            if (!val('firstName')) errors.push('El campo Nombre es obligatorio.');
            if (!val('lastName')) errors.push('El campo Apellido es obligatorio.');
            if (!val('gender')) errors.push('Debes seleccionar un Género.');
            if (!val('document')) errors.push('El campo Documento es obligatorio.');
            if (!val('birthDate')) errors.push('La Fecha de nacimiento es obligatoria.');

            // Ubicación
            if (!val('provinciaSelect')) errors.push('Debes seleccionar una Provincia.');
            if (!val('departamentoSelect')) errors.push('Debes seleccionar un Departamento.');
            if (!val('municipioSelect')) errors.push('Debes seleccionar un Municipio.');
            if (!val('localidadSelect')) errors.push('Debes seleccionar una Localidad.');

            // Dirección
            if (!val('street')) errors.push('El campo Calle es obligatorio.');
            const number = val('number');
            if (!number) errors.push('El campo Número es obligatorio.');
            else if (!onlyDigits(number)) errors.push('El campo Número debe contener solo números.');

            const postal = val('postalCode');
            if (!postal) errors.push('El Código Postal es obligatorio.');
            else if (!onlyDigits(postal)) errors.push('El Código Postal debe contener solo números.');

            // Teléfono
            const phoneCode = val('phoneCode');
            if (!phoneCode) errors.push('El Código de área es obligatorio.');
            else if (!onlyDigits(phoneCode)) errors.push('El Código de área debe contener solo números.');

            const phoneNumber = val('phoneNumber');
            if (!phoneNumber) errors.push('El Número de teléfono es obligatorio.');
            else if (!onlyDigits(phoneNumber)) errors.push('El Número de teléfono debe contener solo números.');

            // Términos
            const terms = getEl('terms');
            if (!terms?.checked) errors.push('Debes aceptar los Términos y Condiciones y la Política de Privacidad.');

            return errors;
        }

        // -------------------------
        // Validación en tiempo real
        // -------------------------
        function debounce(fn, wait=600) {
            let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
        }

        function setInlineStatus(el, state, message) {
            if (!el) return;
            const states = {
                checking: { cls: 'text-gray-600', icon: '<i class="fa-solid fa-spinner fa-spin mr-2"></i>' },
                ok:       { cls: 'text-green-600', icon: '<i class="fa-solid fa-circle-check mr-2"></i>' },
                error:    { cls: 'text-red-600',   icon: '<i class="fa-solid fa-circle-xmark mr-2"></i>' },
                idle:     { cls: 'text-gray-600',  icon: '' }
            };
            const s = states[state] || states.idle;
            el.className = `text-sm mt-1 h-5 ${s.cls}`;
            el.innerHTML = message ? `${s.icon}${message}` : '';
        }

        function availableFromResponse(data) {
            if (typeof data === 'boolean') return data;
            if (data && typeof data === 'object') {
                if ('available' in data) return !!data.available;
                if ('disponible' in data) return !!data.disponible;
                if ('exists' in data) return !data.exists;
                if ('taken' in data) return !data.taken;
            }
            if (typeof data === 'string') {
                const s = data.toLowerCase();
                if (s.includes('disponible') || s.includes('available')) return true;
                if (s.includes('no disponible') || s.includes('existe') || s.includes('taken')) return false;
            }
            return null; // desconocido
        }

        async function checkUsernameAvailability(username) {
            const url = `${ACCOUNT_API.CHECK_USERNAME}?username=${encodeURIComponent(username)}`;
            try {
                const data = await safeFetch(url);
                return availableFromResponse(data);
            } catch { return null; }
        }

        async function checkEmailAvailability(email) {
            const url = `${ACCOUNT_API.CHECK_EMAIL}?email=${encodeURIComponent(email)}`;
            try {
                const data = await safeFetch(url);
                return availableFromResponse(data);
            } catch { return null; }
        }

        // Asegurar que cada <li> tenga el texto original en data-label (se ejecuta una vez)
        (function initPasswordChecklistLabels(){
            ['pwc-length','pwc-upper','pwc-number','pwc-special'].forEach(id => {
                const li = document.getElementById(id);
                if (!li) return;
                // si no tiene data-label guardamos el texto limpio actual
                if (!li.dataset.label) {
                    // quitamos posibles iconos ya presentes y guardamos el texto
                    li.dataset.label = li.textContent.replace(/^[\u25CF\u25CB\u25A0\u25A1\uf000-\uf8ff\s]+/,'').trim() || li.textContent.trim();
                }
            });
        })();

        function updatePasswordChecklist(pass) {
            const setItem = (id, ok) => {
                const li = document.getElementById(id);
                if (!li) return;
                const iconOk = '<i class="fa-solid fa-circle-check mr-2"></i>';
                const iconKo = '<i class="fa-solid fa-circle-xmark mr-2"></i>';
                const label = li.dataset.label || li.textContent.trim();
                li.classList.toggle('text-green-600', !!ok);
                li.classList.toggle('text-red-600', !ok);
                li.innerHTML = (ok ? iconOk : iconKo) + ' ' + label;
            };
            setItem('pwc-length', pass.length >= 8);
            setItem('pwc-upper', /[A-Z]/.test(pass));
            setItem('pwc-number', /[0-9]/.test(pass));
            setItem('pwc-special', /[^A-Za-z0-9]/.test(pass));
        }

        function updatePasswordMatch() {
            const pass = document.getElementById('password')?.value || '';
            const pass2 = document.getElementById('passwordConfirm')?.value || '';
            const el = document.getElementById('passwordMatch');
            if (!el || (!pass && !pass2)) { if (el) setInlineStatus(el, 'idle', ''); return; }
            if (pass && pass2 && pass === pass2) {
                setInlineStatus(el, 'ok', 'Las contraseñas coinciden.');
            } else {
                setInlineStatus(el, 'error', 'Las contraseñas no coinciden.');
            }
        }

        function wireRealtimeValidation() {
            const u = document.getElementById('username');
            const uStatus = document.getElementById('usernameStatus');
            const e = document.getElementById('email');
            const eStatus = document.getElementById('emailStatus');
            const p = document.getElementById('password');
            const p2 = document.getElementById('passwordConfirm');

            if (u && uStatus) {
                const doCheck = debounce(async () => {
                    const val = (u.value || '').trim();
                    if (!val || val.length < 6) { setInlineStatus(uStatus, 'idle', ''); return; }
                    setInlineStatus(uStatus, 'checking', 'Comprobando disponibilidad...');
                    const available = await checkUsernameAvailability(val);
                    if (available === true) setInlineStatus(uStatus, 'ok', 'Usuario disponible.');
                    else if (available === false) setInlineStatus(uStatus, 'error', 'Usuario no disponible.');
                    else setInlineStatus(uStatus, 'idle', 'No se pudo verificar ahora.');
                }, 700);
                u.addEventListener('input', doCheck);
                u.addEventListener('blur', () => doCheck());
            }

            if (e && eStatus) {
                const doCheck = debounce(async () => {
                    const val = (e.value || '').trim();
                    if (!val) { setInlineStatus(eStatus, 'idle', ''); return; }
                    if (e.validity?.typeMismatch) {
                        setInlineStatus(eStatus, 'error', 'Formato de correo inválido.');
                        return;
                    }
                    setInlineStatus(eStatus, 'checking', 'Comprobando disponibilidad...');
                    const available = await checkEmailAvailability(val);
                    if (available === true) setInlineStatus(eStatus, 'ok', 'Correo disponible.');
                    else if (available === false) setInlineStatus(eStatus, 'error', 'Correo ya registrado.');
                    else setInlineStatus(eStatus, 'idle', 'No se pudo verificar ahora.');
                }, 700);
                e.addEventListener('input', doCheck);
                e.addEventListener('blur', () => doCheck());
            }

            if (p) {
                updatePasswordChecklist(p.value || '');
                p.addEventListener('input', () => {
                    updatePasswordChecklist(p.value || '');
                    updatePasswordMatch();
                });
            }
            if (p2) {
                p2.addEventListener('input', updatePasswordMatch);
            }
        }

        // -------------------------
        // handleSubmit (sin cambios fuera de las nuevas reglas)
        // -------------------------
        function handleSubmit(evt) {
            evt.preventDefault();

            const btn = document.getElementById('submitBtn');
            const spinner = document.getElementById('spinner');
            const btnText = document.getElementById('btnText');

            clearErrors();
            const errors = validateForm();
            if (errors.length) {
                showErrors(errors);
                return;
            }

            spinner.style.display = 'inline-block';
            btnText.textContent = 'Creando...';
            btn.disabled = true;

            // Fecha a yyyy-MM-dd
            const bdVal = document.getElementById('birthDate').value;
            const fechaNacimiento = bdVal || null;

            // 1) Usuario (RegistroUsuarioDTO)
            const usuarioPayload = {
                username: document.getElementById('username').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                tipoUsuario: 'PERSONA_FISICA',
                idioma: 'es',
                timezone: 'America/Argentina/Buenos_Aires',
                rol: 'ROLE_USUARIO',
                aceptaTerminos: document.getElementById('terms').checked,
                aceptaPoliticaPriv: document.getElementById('terms').checked
            };

            // 2) PerfilUsuario (PerfilUsuarioCreateDTO)
            const perfilUsuarioPayload = {
                nombre: document.getElementById('firstName').value,
                apellido: document.getElementById('lastName').value,
                documento: document.getElementById('document').value,
                genero: document.getElementById('gender').value,
                fechaNacimiento: fechaNacimiento,
                cargo: null,
                correoAlternativo: null
            };

            // 3) Teléfono (RegistroTelefonoDTO)
            const telefonoPayload = {
                caracteristica: document.getElementById('phoneCode').value,
                numero: document.getElementById('phoneNumber').value,
                tipo: 'PRINCIPAL'
            };

            // 4) Dirección (RegistroDireccionDTO)
            const direccionPayload = {
                tipo: 'ENVIO',
                paisId: 1,
                provinciaId: parseInt(document.getElementById('provinciaSelect').value) || null,
                departamentoId: parseInt(document.getElementById('departamentoSelect').value) || null,
                municipioId: parseInt(document.getElementById('municipioSelect').value) || null,
                localidadId: parseInt(document.getElementById('localidadSelect').value) || null,
                calle: document.getElementById('street').value,
                numero: document.getElementById('number').value,
                piso: document.getElementById('floor').value || null,
                departamentoInterno: document.getElementById('apartment') ? document.getElementById('apartment').value || null : null,
                codigoPostal: document.getElementById('postalCode').value,
                referencia: document.getElementById('reference').value || null,
                activa: true,
                esPrincipal: true
            };

            // 5) DTO completo
            const payload = {
                usuario: usuarioPayload,
                perfilUsuario: perfilUsuarioPayload,
                direcciones: [direccionPayload],
                telefonos: [telefonoPayload]
            };

            fetch('/api/gestionusuario/public/usuario/registro', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(async res => {
                spinner.style.display = 'none';
                btnText.textContent = 'Crear cuenta';
                btn.disabled = false;

                if (res.ok) {
                    window.location.href = '/public/correoEnviado(verificarCorreo).html';
                    return;
                }
                const text = await res.text().catch(() => null);
                return Promise.reject(text || `HTTP ${res.status}`);
            })
            .catch(err => {
                console.error('Error registro:', err);
                const msg = typeof err === 'string' ? err : 'Error al crear cuenta. Intentá nuevamente.';
                showErrors([msg]);
            });
        }
    </script>

    <div id="session-status" aria-live="polite">
        <div style="font-weight:600; margin-bottom:6px;">Estado de sesión</div>
        <div class="row"><div class="label">Sesión:</div><div><span id="ss-sesion-label">Comprobando...</span> <span id="ss-dot" class="status-dot"></span></div></div>
        <div class="row"><div class="label">Usuario:</div><div id="ss-usuario">---</div></div>
        <div class="row"><div class="label">Rol:</div><div id="ss-rol">---</div></div>
        <div class="row"><div class="label">JWT:</div><div id="ss-jwt">---</div></div>
        <div class="row"><div class="label">Refresh:</div><div id="ss-refresh">---</div></div>
        <div style="margin-top:6px; font-size:11px; color:#666;">Última comprobación: <span id="ss-last">nunca</span></div>
    </div>

    <script src="/js/ubicaciones.js"></script>
    <script src="/js/auth-client.js"></script>
    <script src="/js/session-status.js"></script>
</body>
</html>
